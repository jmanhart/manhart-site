---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";

const isServer = import.meta.env.SSR;
const baseUrl = import.meta.env.MODE === "development"
  ? "http://localhost:4321"
  : "https://manhart.io"; 
const apiUrl = `${baseUrl}/api/records`;

console.log("üì° Fetching from:", apiUrl);

let collection = [];
try {
  const response = await fetch(apiUrl);
  console.log("üì° API response status:", response.status);

  if (!response.ok) throw new Error(`Failed to fetch records (status ${response.status})`);

  collection = await response.json();
  console.log("üì° Records received:", collection);

  // Sort alphabetically by artist
  collection.sort((a, b) => {
    const artistA = a.artist?.toLowerCase() || '';
    const artistB = b.artist?.toLowerCase() || '';
    return artistA < artistB ? -1 : artistA > artistB ? 1 : 0;
  });
} catch (error) {
  console.error("‚ùå Error fetching collection:", error);
  collection = []; // Fallback to an empty array
}
---

<html lang="en">
  <head>
    <BaseHead title="All Records" description="My record collection" />
  </head>
  <body>
    <Header />
    <div class="sub-page-wrapper" id="sub-page">
      <div class="root-content text-page">
        <div class="info-container">
          <h2>üé∂ All Records</h2>
          <p class="blog-short-description">Album Count: {collection.length}</p>
          <div id="collection-list">
            {collection.length > 0 ? (
              <>
                {collection.map((release) => (
                  <div
                    class="release"
                    style="display: flex; align-items: center; margin-bottom: 15px;"
                  >
                    {release.supabase_image_url ? (
                      <img
                        src={release.supabase_image_url} // ‚úÖ Correct reference
                        alt={`Cover of ${release.title}`}
                        style="width: 50px; height: 50px; object-fit: cover; margin-right: 15px; border-radius: 5px;"
                      />
                    ) : (
                      <div> No Image </div>
                    )}
                    <div>
                      <h3 style="font-style: italic; margin: 0;">
                        {release.title}
                      </h3>
                      <p style="margin: 0;">
                        {release.artist || 'Unknown Artist'}
                      </p>
                    </div>
                  </div>
                ))}
              </>
            ) : (
              <p>No records found.</p>
            )}
          </div>
        </div>
      </div>
    </div>
  </body>
</html>



